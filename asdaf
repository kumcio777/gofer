from kivy.app import App
from kivy.uix.button import Button
from kivy.uix.label import Label
from kivy.uix.boxlayout import BoxLayout
from kivy.clock import Clock
from phue import Bridge

class HueControlApp(App):
    def build(self):
        self.title = 'Hue Control App'
        self.bridge = Bridge('95.49.57.121')

        layout = BoxLayout(orientation='vertical', spacing=10, padding=10)
        
        self.label_licznik = Label(text="Liczba kliknięć: 0")
        layout.add_widget(self.label_licznik)

        button = Button(text="Kliknij mnie")
        button.bind(on_press=self.obsluz_klikniecie)
        layout.add_widget(button)

        return layout

    def obsluz_klikniecie(self, instance):
        if not hasattr(self, 'last_click_time'):
            self.last_click_time = 0

        current_time = Clock.get_time()
        elapsed_time = current_time - self.last_click_time

        if elapsed_time > 2:
            self.last_click_time = current_time

            self.licznik_klikniec += 1
            self.label_licznik.text = f"Liczba kliknięć: {self.licznik_klikniec}"
            self.zapisz_licznik()

            self.bridge.set_light(1, 'on', True)
            self.bridge.set_light(1, 'hue', 0)
            self.bridge.set_light(1, 'sat', 254)

            self.timer_start()

    def timer_start(self):
        Clock.schedule_once(self.zakoncz_akcje, 2)

    def zakoncz_akcje(self, dt):
        self.bridge.set_light(1, 'on', False)

    def zapisz_licznik(self):
        with open("licznik.txt", "w") as file:
            file.write(str(self.licznik_klikniec))

    def wczytaj_licznik(self):
        try:
            with open("licznik.txt", "r") as file:
                self.licznik_klikniec = int(file.read())
                self.label_licznik.text = f"Liczba kliknięć: {self.licznik_klikniec}"
        except FileNotFoundError:
            pass

if __name__ == '__main__':
    HueControlApp().run()
